name: macos

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - "main"

permissions:
  contents: read

env:
  GCS_ACCOUNT_SECRET: 'secret/observability-team/ci/snapshoty'
  DOCKER_REGISTRY_SECRET: 'secret/observability-team/ci/docker-registry/prod'

jobs:
  macos:
    runs-on: macos-12
    steps:
    - uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '14.0'

    - uses: actions/checkout@v3

    - name: Run build
      run: .ci/scripts/build.sh

    - name: Run test
      run: xcodebuild -scheme apm-agent-ios-Package -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 8' test

    - name: Run package snapshots
      run: .ci/scripts/package.sh

    - uses: actions/upload-artifact@v3
      with:
        name: snapshoty
        path: |
          .ci/snapshoty.yml
          dist/**

  macos-publish-snapshots:
    runs-on: ubuntu-latest
    needs: [macos]
    steps:
    - uses: actions/download-artifact@v3
      with:
        name: snapshoty
    - uses: elastic/apm-pipeline-library/.github/actions/docker-login@current
      with:
        registry: docker.elastic.co
        secret: ${{ env.DOCKER_REGISTRY_SECRET }}
        url: ${{ secrets.VAULT_ADDR }}
        roleId: ${{ secrets.VAULT_ROLE_ID }}
        secretId: ${{ secrets.VAULT_SECRET_ID }}

    - uses: hashicorp/vault-action@v2
      with:
        url: ${{ secrets.VAULT_ADDR }}
        roleId: ${{ secrets.VAULT_ROLE_ID }}
        secretId: ${{ secrets.VAULT_SECRET_ID }}
        method: approle
        secrets: |
          ${{ env.GCS_ACCOUNT_SECRET }} client_email | GCS_CLIENT_EMAIL ;
          ${{ env.GCS_ACCOUNT_SECRET }} private_key | GCS_PRIVATE_KEY ;
          ${{ env.GCS_ACCOUNT_SECRET }} private_key_id | GCS_PRIVATE_KEY_ID ;
          ${{ env.GCS_ACCOUNT_SECRET }} project_id | GCS_PROJECT

    - name: Publish snaphosts
      uses: elastic/apm-pipeline-library/.github/actions/snapshoty@current
      with:
        config: '.ci/snapshoty.yml'
        bucketName: 'oblt-artifacts'
        gcsClientEmail: '${{ env.GCS_CLIENT_EMAIL }}'
        gcsPrivateKey: '${{ env.GCS_PRIVATE_KEY }}'
        gcsPrivateKeyId: '${{ env.GCS_PRIVATE_KEY_ID }}'
        gcsProject: '${{ env.GCS_PROJECT }}'
